// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgres"
  url      = env("DATABASE_URL")
}

model User {
  id            String          @id @default(cuid())
  name          String
  email         String
  emailVerified Boolean         @default(false)
  image         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]
  members       Member[]
  invitations   Invitation[]
  integrations  Integration[]
  OAuthTemp     OAuthTemp[]
  // Personal preferences
  preferences   UserPreference?

  // Actions taken by user
  activityLogs ActivityLog[]
  comments     Comment[]

  // Items assigned to or owned by user
  assignedTasks    Task[]         @relation("TaskAssignee")
  ownedCustomViews CustomView[]
  notifications    Notification[]

  @@unique([email])
  @@map("user")
}

model Session {
  id                   String   @id
  expiresAt            DateTime
  token                String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  ipAddress            String?
  userAgent            String?
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeOrganizationId String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([userId, providerId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Organization {
  id              String        @id @default(cuid())
  name            String
  slug            String?
  description     String?
  logo            String?
  createdAt       DateTime
  metadata        String?
  // Billing & plan
  plan            String        @default("FREE") // FREE, PRO, ENTERPRISE
  billingEmail    String?
  polarCustomerId String?
  subscription    Subscription?
  members         Member[]
  invitations     Invitation[]
  // Relations
  integrations    Integration[] // Connected tools
  // Team collaboration
  customViews     CustomView[]
  comments        Comment[]

  // Team data
  tasks          Task[]
  messages       Message[]
  documents      Document[]
  analyticsData  AnalyticsData[]
  feedbackItems  FeedbackItem[]
  designFiles    DesignFile[]
  codeRepos      Repository[]
  supportTickets SupportTicket[]

  // Team activity
  activityLogs  ActivityLog[]
  notifications Notification[]

  // Settings
  settings OrganizationSettings?

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime     @default(now())

  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Subscription {
  id                          String       @id @default(cuid())
  createdAt                   DateTime     @default(now())
  modifiedAt                  DateTime?
  amount                      Int
  currency                    String
  recurringInterval           String
  status                      String
  currentPeriodStart          DateTime
  currentPeriodEnd            DateTime
  cancelAtPeriodEnd           Boolean      @default(false)
  canceledAt                  DateTime?
  startedAt                   DateTime
  endsAt                      DateTime?
  endedAt                     DateTime?
  customerId                  String
  subscriptionId              String?
  productId                   String
  discountId                  String?
  checkoutId                  String
  customerCancellationReason  String?
  customerCancellationComment String?
  metadata                    String? // JSON string
  customFieldData             String? // JSON string
  organizationId              String       @unique
  // Relation to Organization model
  organization                Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("subscription")
}

enum Role {
  OWNER // Full access, billing, delete organization
  ADMIN // Manage members, integrations, settings
  MEMBER // Standard access, create/edit content
  VIEWER // Read-only access
  GUEST // Limited access to specific projects
}

model OrganizationSettings {
  id String @id @default(cuid())

  // Integration settings
  allowMembersToAddIntegrations  Boolean @default(false)
  requireApprovalForIntegrations Boolean @default(true)

  // Data settings
  dataRetentionDays Int     @default(90)
  allowDataExport   Boolean @default(true)

  // Collaboration settings
  allowGuestAccess    Boolean @default(false)
  requireMFAForAdmins Boolean @default(false)

  // Notification defaults
  defaultNotificationSettings Json @default("{}")

  updatedAt DateTime @updatedAt

  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model UserPreference {
  id                    String  @id @default(cuid())
  theme                 String  @default("light")
  timezone              String  @default("UTC")
  defaultOrganizationId String?

  // Per-organization notification preferences
  notificationSettings Json @default("{}")

  updatedAt DateTime @updatedAt
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum IntegrationCategory {
  PAYMENT // Stripe, PayPal, Square, etc.
  ANALYTICS // Mixpanel, Amplitude, Google Analytics
  CRM // HubSpot, Salesforce, Pipedrive
  SUPPORT // Zendesk, Intercom, Freshdesk
  PROJECT_MGMT // Asana, Trello, Jira, Linear
  COMMUNICATION // Slack, Discord, Microsoft Teams
  EMAIL_MARKETING // Mailchimp, SendGrid, ActiveCampaign
  DEVELOPMENT // GitHub, GitLab, CircleCI
  ACCOUNTING // QuickBooks, Xero, Wave
  SOCIAL_MEDIA // Buffer, Hootsuite, Later
  SEO // Ahrefs, SEMrush
  FEEDBACK // Typeform, SurveyMonkey
  SCHEDULING // Calendly, Cal.com
  DEVOPS // Datadog, Sentry
  AI // OpenAI, Anthropic
  OTHER
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  PENDING_SETUP // Waiting for user to complete webhook setup
  SYNCING
}

enum TaskStatus {
  open
  in_progress
  done
}

enum IntegrationType {
  oauth1a
  oauth2
  api_key
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum WebhookSetupType {
  AUTOMATIC // App creates webhook via API
  MANUAL // User must configure in platform
  HYBRID // Combination of both
}

model Integration {
  id               String              @id @default(cuid())
  category         IntegrationCategory
  status           IntegrationStatus   @default(PENDING_SETUP)
  lastSyncAt       DateTime?
  platform         String // e.g., "stripe", "jira"
  displayName      String?
  type             IntegrationType     @default(oauth2)
  lastSyncStatus   String?
  syncInterval     Int? // Minutes, e.g., 15
  attributes       Json?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  // OAuth & API Credentials (encrypted)
  accessToken      String? // Encrypted OAuth access token
  refreshToken     String? // Encrypted OAuth refresh token
  tokenExpiresAt   DateTime?
  apiKey           String? // Encrypted API key (for non-OAuth)
  apiSecret        String? // Encrypted API secret
  webhookSecret    String? // For webhook signature verification
  // Webhook Configuration
  webhookUrl       String? // The webhook URL we provide to user
  webhookId        String? // Platform's webhook ID (if created via API)
  webhookEvents    String[] // Events subscribed to
  webhookSetupType WebhookSetupType    @default(AUTOMATIC)
  webhookConfirmed Boolean             @default(false) // For MANUAL webhook Configuration
  // Platform-specific metadata
  metadata         Json? // Store platform-specific IDs, settings
  // Multi-tenant field
  organizationId   String
  // Related data (all shared across team)
  tasks            Task[]
  messages         Message[]
  documents        Document[]
  analyticsData    AnalyticsData[]
  feedbackItems    FeedbackItem[]
  designFiles      DesignFile[]
  repos            Repository[]
  supportTickets   SupportTicket[]
  // Relations
  organization     Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  User             User?               @relation(fields: [userId], references: [id])
  userId           String?

  @@unique([organizationId, platform])
  @@index([organizationId, status])
  @@index([organizationId, category])
}

model Webhook {
  id           String     @id @default(uuid())
  repositoryId String
  externalId   String
  platform     String
  url          String?
  events       String[] // Store as JSON array
  active       Boolean
  attributes   Json? // Store additional metadata (e.g., content_type, created_at)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  repository   Repository @relation(fields: [repositoryId], references: [id])

  @@unique([externalId, platform])
}

model OAuthTemp {
  id               String   @id @default(cuid())
  userId           String
  provider         String
  oauthToken       String?
  oauthTokenSecret String?
  state            String?
  expiresAt        DateTime
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId, provider])
  @@map("oauth_temp")
}

// ============================================
// PROJECT TRACKING & TASKS
// ============================================
model Task {
  id         String @id @default(cuid())
  externalId String // ID from source system

  title       String
  description String? @db.Text
  status      String
  priority    String?
  type        String?

  // Assignment (can be any user, not just organization members)
  assigneeId     String?
  assigneeName   String?
  assigneeAvatar String?
  assignee       User?   @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  reporterId   String?
  reporterName String?

  // Dates
  dueDate     DateTime?
  startDate   DateTime?
  completedAt DateTime?

  // Estimation
  estimatedHours Float?
  actualHours    Float?
  storyPoints    Int?

  // Organization
  labels       String[]
  sprintId     String?
  sprintName   String?
  projectId    String?
  projectName  String?
  epicId       String?
  epicName     String?
  parentTaskId String?

  // Relationships
  dependencies String[] // External IDs

  // Metadata
  url      String?
  metadata Json?

  createdAt      DateTime
  updatedAt      DateTime
  syncedAt       DateTime     @default(now())
  // Belongs to organization (team-shared)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Came from which integration
  integrationId String
  integration   Integration   @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  // Team collaboration
  comments      Comment[]     @relation("TaskComments")
  linkedItems   LinkedItem[]  @relation("TaskLinks")
  watchers      TaskWatcher[]

  @@unique([organizationId, externalId, integrationId])
  @@index([organizationId, status])
  @@index([organizationId, assigneeId])
  @@index([organizationId, dueDate])
  @@index([projectId, status])
}

// Communication Category
model Message {
  id         String @id @default(cuid())
  externalId String

  channelId   String
  channelName String
  channelType String // CHANNEL, DM, THREAD

  content String @db.Text

  authorId     String?
  authorName   String
  authorAvatar String?

  mentions  String[] // User IDs or @channel
  reactions Json?

  threadId        String?
  parentMessageId String?

  hasAttachments Boolean @default(false)
  attachments    Json?

  isPinned    Boolean @default(false)
  isImportant Boolean @default(false)

  url            String?
  timestamp      DateTime
  syncedAt       DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  platform      String
  integrationId String
  integration   Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  comments      Comment[]    @relation("MessageComments")
  linkedItems   LinkedItem[] @relation("MessageLinks")

  @@unique([externalId, platform])
  @@unique([organizationId, externalId, integrationId])
  @@index([externalId, platform, organizationId])
  @@index([organizationId, channelId])
  @@index([organizationId, timestamp])
  @@index([channelId, timestamp])
}

model TaskWatcher {
  id      String   @id @default(cuid())
  taskId  String
  task    Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId  String
  addedAt DateTime @default(now())

  @@unique([taskId, userId])
}

// ============================================
// DOCUMENTS
// ============================================
model Document {
  id         String @id @default(cuid())
  externalId String

  title   String
  content String? @db.Text
  excerpt String?
  type    String?

  parentId String?
  path     String?

  authorId       String?
  authorName     String?
  lastEditorId   String?
  lastEditorName String?

  url      String?
  isPublic Boolean @default(false)

  viewCount Int @default(0)

  tags   String[]
  status String?

  metadata Json?

  createdAt      DateTime
  updatedAt      DateTime
  syncedAt       DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  integrationId String
  integration   Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  comments      Comment[]    @relation("DocumentComments")
  linkedItems   LinkedItem[] @relation("DocumentLinks")

  @@unique([organizationId, externalId, integrationId])
  @@index([organizationId, title])
  @@index([organizationId, updatedAt])
}

model FeedbackItem {
  id         String @id @default(cuid())
  externalId String

  type        String
  title       String
  description String @db.Text
  platform    String

  status   String  @default("NEW")
  priority String?

  sentiment      String?
  sentimentScore Float?

  category String?
  tags     String[]

  votes Int @default(0)

  userId      String?
  userName    String?
  userEmail   String?
  userSegment String?

  assignedTo    String?
  linkedFeature String?

  url      String?
  metadata Json?

  createdAt      DateTime
  updatedAt      DateTime
  syncedAt       DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  integrationId String
  integration   Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  comments      Comment[]    @relation("FeedbackComments")
  linkedItems   LinkedItem[] @relation("FeedbackLinks")

  @@unique([externalId, platform])
  @@unique([organizationId, externalId, integrationId])
  @@index([organizationId, type, status])
  @@index([organizationId])
  @@index([status])
}

// ============================================
// DESIGN FILES
// ============================================
model DesignFile {
  id         String @id @default(cuid())
  externalId String

  name        String
  description String? @db.Text
  type        String
  fileType    String?

  url          String?
  thumbnailUrl String?

  status  String?
  version String?

  authorId       String?
  authorName     String?
  lastEditorId   String?
  lastEditorName String?

  projectId   String?
  projectName String?

  tags     String[]
  metadata Json?

  createdAt      DateTime
  updatedAt      DateTime
  syncedAt       DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  integrationId String
  integration   Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  comments      Comment[]    @relation("DesignComments")
  linkedItems   LinkedItem[] @relation("DesignLinks")

  @@unique([organizationId, externalId, integrationId])
  @@index([organizationId, status])
  @@index([organizationId, updatedAt])
}

// ============================================
// CODE REPOSITORIES
// ============================================
// ============================================
// ANALYTICS
// ============================================
model AnalyticsData {
  id String @id @default(cuid())

  metricName  String
  metricValue Float
  metricUnit  String?

  dimension      String?
  dimensionValue String?

  timestamp   DateTime
  granularity String

  metadata       Json?
  syncedAt       DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, integrationId, metricName, dimension, dimensionValue, timestamp])
  @@index([organizationId, metricName, timestamp])
}

// ============================================
// REPOSITORIES
// ============================================
model Repository {
  id         String @id @default(cuid())
  externalId String

  name        String
  fullName    String
  description String? @db.Text
  platform    String

  url           String?
  language      String?
  isPrivate     Boolean @default(true)
  defaultBranch String  @default("main")

  stars      Int @default(0)
  openIssues Int @default(0)
  openPRs    Int @default(0)

  metadata Json?

  createdAt      DateTime
  updatedAt      DateTime
  syncedAt       DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  integrationId String
  integration   Integration   @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  pullRequests  PullRequest[]
  commits       Commit[]
  builds        Build[]
  Webhook       Webhook[]

  @@unique([externalId, platform])
  @@index([organizationId, name])
  @@index([externalId, platform])
}

model PullRequest {
  id         String @id @default(cuid())
  externalId String
  number     Int

  title       String
  description String? @db.Text
  state       String

  authorId     String?
  authorName   String
  authorAvatar String?

  reviewers      Json?
  approvalStatus String?

  sourceBranch String
  targetBranch String

  additions    Int @default(0)
  deletions    Int @default(0)
  changedFiles Int @default(0)

  labels String[]
  url    String?

  mergedAt     DateTime?
  closedAt     DateTime?
  createdAt    DateTime
  updatedAt    DateTime
  syncedAt     DateTime     @default(now())
  repositoryId String
  repository   Repository   @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  comments     Comment[]    @relation("PRComments")
  linkedItems  LinkedItem[] @relation("PRLinks")

  @@unique([repositoryId, externalId])
  @@index([repositoryId, state])
}

model Commit {
  id         String @id @default(cuid())
  externalId String

  message     String  @db.Text
  authorName  String
  authorEmail String
  authorId    String?

  branch       String?
  additions    Int     @default(0)
  deletions    Int     @default(0)
  filesChanged Int     @default(0)

  url          String?
  timestamp    DateTime
  syncedAt     DateTime   @default(now())
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@unique([repositoryId, externalId])
  @@index([repositoryId, timestamp])
}

model Build {
  id         String @id @default(cuid())
  externalId String

  status      String
  buildNumber Int?
  branch      String?
  commitSha   String?
  triggeredBy String?
  duration    Int?

  url          String?
  startedAt    DateTime?
  completedAt  DateTime?
  syncedAt     DateTime   @default(now())
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@unique([repositoryId, externalId])
  @@index([repositoryId, status])
}

// ============================================
// SUPPORT TICKETS
// ============================================
model SupportTicket {
  id           String  @id @default(cuid())
  externalId   String
  ticketNumber String?

  subject     String
  description String? @db.Text

  status   String
  priority String?
  type     String?
  channel  String?

  customerId    String?
  customerName  String?
  customerEmail String?

  assignedToId   String?
  assignedToName String?
  teamId         String?
  teamName       String?

  tags              String[]
  slaStatus         String?
  satisfactionScore Int?

  firstResponseAt DateTime?
  resolvedAt      DateTime?

  url      String?
  metadata Json?

  createdAt      DateTime
  updatedAt      DateTime
  syncedAt       DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  integrationId String
  integration   Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  comments      Comment[]    @relation("TicketComments")
  linkedItems   LinkedItem[] @relation("TicketLinks")

  @@unique([organizationId, externalId, integrationId])
  @@index([organizationId, status, priority])
  @@index([organizationId, slaStatus])
}

// ============================================
// UNIVERSAL COMMENT SYSTEM
// ============================================
model Comment {
  id      String @id @default(cuid())
  content String @db.Text

  // Polymorphic - can comment on anything
  entityType String // TASK, MESSAGE, DOCUMENT, FEEDBACK, DESIGN, PR, TICKET
  entityId   String

  // Author
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Thread support
  parentId String?
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentThread")

  // Reactions
  reactions Json? @default("{}") // { "üëç": ["user1", "user2"], "‚ù§Ô∏è": ["user3"] }

  // Status
  isEdited   Boolean   @default(false)
  isResolved Boolean   @default(false)
  resolvedBy String?
  resolvedAt DateTime?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Polymorphic relations
  task        Task?          @relation("TaskComments", fields: [entityId], references: [id], onDelete: Cascade, map: "fk_comment_to_task")
  message     Message?       @relation("MessageComments", fields: [entityId], references: [id], onDelete: Cascade, map: "fk_comment_to_message")
  document    Document?      @relation("DocumentComments", fields: [entityId], references: [id], onDelete: Cascade, map: "fk_comment_to_document")
  feedback    FeedbackItem?  @relation("FeedbackComments", fields: [entityId], references: [id], onDelete: Cascade, map: "fk_comment_to_feedback")
  design      DesignFile?    @relation("DesignComments", fields: [entityId], references: [id], onDelete: Cascade, map: "fk_comment_to_design")
  pullRequest PullRequest?   @relation("PRComments", fields: [entityId], references: [id], onDelete: Cascade, map: "fk_comment_to_pr")
  ticket      SupportTicket? @relation("TicketComments", fields: [entityId], references: [id], onDelete: Cascade, map: "fk_comment_to_ticket")

  @@index([organizationId, entityType, entityId])
  @@index([authorId])
  @@index([createdAt])
}

// ============================================
// CROSS-TOOL LINKING
// ============================================
model LinkedItem {
  id String @id @default(cuid())

  sourceType String
  sourceId   String
  targetType String
  targetId   String

  linkType    String? // RELATED_TO, BLOCKS, CAUSED_BY, IMPLEMENTS, FIXES, etc.
  description String?

  createdBy   String?
  createdAt   DateTime       @default(now())
  // Polymorphic relations
  task        Task?          @relation("TaskLinks", fields: [sourceId], references: [id], onDelete: Cascade, map: "fk_link_to_task")
  message     Message?       @relation("MessageLinks", fields: [sourceId], references: [id], onDelete: Cascade, map: "fk_link_to_message")
  document    Document?      @relation("DocumentLinks", fields: [sourceId], references: [id], onDelete: Cascade, map: "fk_link_to_document")
  feedback    FeedbackItem?  @relation("FeedbackLinks", fields: [sourceId], references: [id], onDelete: Cascade, map: "fk_link_to_feedback")
  design      DesignFile?    @relation("DesignLinks", fields: [sourceId], references: [id], onDelete: Cascade, map: "fk_link_to_design")
  pullRequest PullRequest?   @relation("PRLinks", fields: [sourceId], references: [id], onDelete: Cascade, map: "fk_link_to_pr")
  ticket      SupportTicket? @relation("TicketLinks", fields: [sourceId], references: [id], onDelete: Cascade, map: "fk_link_to_ticket")

  @@unique([sourceType, sourceId, targetType, targetId])
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
}

// ============================================
// CUSTOM VIEWS & DASHBOARDS
// ============================================
model CustomView {
  id          String  @id @default(cuid())
  name        String
  description String?
  type        String

  // Visibility
  visibility String @default("PRIVATE") // PRIVATE, TEAM, WORKSPACE

  // Layout configuration
  layout  Json
  filters Json?

  // Ownership
  createdBy String
  creator   User   @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  // Sharing
  sharedWith String[] // User IDs who can view/edit

  isDefault Boolean @default(false)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, visibility])
  @@index([createdBy])
}

// ============================================
// NOTIFICATIONS
// ============================================
model Notification {
  id String @id @default(cuid())

  type     String
  title    String
  message  String @db.Text
  category String
  priority String @default("MEDIUM")

  // Related entity
  entityType String?
  entityId   String?

  actionUrl  String?
  actionText String?

  isRead Boolean   @default(false)
  readAt DateTime?

  metadata  Json?
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId, organizationId, isRead])
  @@index([createdAt])
}

// ============================================
// ACTIVITY LOGGING
// ============================================
model ActivityLog {
  id String @id @default(cuid())

  action     String // CREATED, UPDATED, DELETED, COMMENTED, etc.
  entityType String // TASK, INTEGRATION, MEMBER, etc.
  entityId   String?

  description String @db.Text
  metadata    Json?

  // Who did it
  userId    String?
  user      User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  actorName String? // In case user is deleted

  ipAddress String?
  userAgent String?

  timestamp      DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, timestamp])
  @@index([userId, timestamp])
  @@index([entityType, entityId])
}
